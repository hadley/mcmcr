---
output: github_document
---

<!-- README.md is generated from README.Rmd. Please edit that file -->

```{r, echo = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.path = "tools/README-"
)
```

 [![lifecycle](https://img.shields.io/badge/lifecycle-maturing-blue.svg)](https://www.tidyverse.org/lifecycle/#maturing)
[![Travis-CI Build Status](https://travis-ci.org/poissonconsulting/mcmcr.svg?branch=master)](https://travis-ci.org/poissonconsulting/mcmcr)
[![AppVeyor Build Status](https://ci.appveyor.com/api/projects/status/github/poissonconsulting/mcmcr?branch=master&svg=true)](https://ci.appveyor.com/project/poissonconsulting/mcmcr)
[![Coverage Status](https://img.shields.io/codecov/c/github/poissonconsulting/mcmcr/master.svg)](https://codecov.io/github/poissonconsulting/mcmcr?branch=master)
[![License: MIT](https://img.shields.io/badge/License-MIT-green.svg)](https://opensource.org/licenses/MIT)

# mcmcr

## Introduction

`mcmcr` is an R package to manipulate Monte Carlo Markov Chain (MCMC) samples.

For the purposes of this discussion, an MCMC sample represents the value of a term from a single iteration of a single chain (of a single analysis).
And while a simple parameter such as an intercept corresponds to a single term, more complex parameters such as an interaction between two factors consist of multiple terms with their own inherent dimensionality - in this case a matrix.
Not surprisingly a set of MCMC samples can be stored in different ways.
The three most common S3 classes store MCMC samples as follows:

- `coda::mcmc` stores the MCMC samples from a single chain as a matrix where each each row represents an iteration and each column represents a variable
- `coda::mcmc.list` stores multiple `mcmc` objects (with identical dimensions) as a list where each object represents a parallel chain
- `rjags::mcarray` stores the samples from a single parameter where the initial dimensions are the parameter dimensions, the second to last dimension is iterations and the last dimension is chains.

It is worth noting than in previous releases of `coda` an mcmc object could be multiple chains.
Such objects are obsolete and must be converted to `mcmc.list` objects using the `coda::mcmcUpgrade()` function.
Where possible such objects are automatically coerced to `mcmc.list` objects by the `mcmcr` package functions.

In the first two cases the terms/parameters are represented by a single dimension which means that the dimensionality inherent in the parameters is stored in the labelling of the variables, ie, `"bIntercept", "bInteraction[1,2]", "bInteraction[2,1]", ...`.
The structure of the `mcmc` and `mcmc.list` objects emphasizes the time-series nature of MCMC samples and is optimized for thining.
In contrast `mcarray` objects preserve the dimensionality of the parameters.

The `mcmcr` packages introduces two related S3 classes which also preserve the dimensionality of
the parameters:

- `mcmcr::mcmcarray` is very similar to `rjags::mcarray` except that the first dimension is the chains, the second dimension is iterations and the subsequent dimensions represent the dimensionality of the parameter (it is called `mcmcarray` to emphasize that the MCMC dimensions ie the chains and iterations come first);
- `mcmcr::mcmcr` stores multiple uniquely named `mcmcarray` objects with the same number of chains and iterations.

## Why mcmcr?

`mcmcarray` objects were introduced to facilitate manipulation and querying of the MCMC samples - although they are are just one `aperm` away from `mcarray` objects the fact that the chains and iterations are the first dimensions means many operations can be performed without having to account for the dimensionality of the parameters.
`mcmcr` objects were introduced to allow a set of parameters to be manipulated and queried as a coherent whole.

The `mcmcr` package introduces a variety of (often) generic functions to manipulate and query `mcmcarray` and `mcmcr` objects. In particular it provides functions to

- coerce from and to `mcarray`, `mcmc` and `mcmc.list` objects;
- extract an objects `coef` table as a tibble;
- query an object's `nchains`, `niters`, `npars`, `nterms`, `nsims`
- `subset` objects by chains, iterations or parameter names;
- `bind` multiple objects by their parameters, chains, or iterations;
- `combine` multiple objects by summing or otherwise combining their values;
- `collapse` or `split` an object's chains;
- `mcmc_map` over an objects values; 
- assess if an object has `converged` using `rhat` and `esr` (effectively sampling rate);
- and of course `coef`, `print`, `plot` etc said objects.




Finally, the mcmcr package allows the user to readily `derive` an `mcmcr` object of new parameters (with potentially novel dimensionality) from an existing `mcmcr` object by using standard R code to define the relationship between the 'primary' parameters in the existing object and the 'derived' parameters in the created object (and any other values specified by the user).
No more rerunning a model because you forget to include a derived parameter!

## Demonstration

```{r}
library(mcmcr)

mcmcr <- mcmcr:::mcmcr

mcmcr

parameters(mcmcr)
nchains(mcmcr)
niters(mcmcr)
nterms(mcmcr)

coef(mcmcr)
rhat(mcmcr, by = "term")
esr(mcmcr)
converged(mcmcr)
plot(mcmcr[["alpha"]])

mcmcr2 <- derive(mcmcr, "gamma <- sum(alpha) * sigma")
rhat(mcmcr2)
plot(mcmcr2)
```

## Installation

To install the latest version from GitHub
```
# install.packages("devtools")
devtools::install_github("poissonconsulting/mcmcr")
```

## Citation

```{r, comment="", echo=FALSE}
citation(package = "mcmcr")
```

## Contribution

Please report any [issues](https://github.com/poissonconsulting/mcmcr/issues).

[Pull requests](https://github.com/poissonconsulting/mcmcr/pulls) are always welcome.

Please note that this project is released with a [Contributor Code of Conduct](CONDUCT.md). By participating in this project you agree to abide by its terms.

## Inspiration

[coda](https://github.com/cran/coda) and [rjags](https://github.com/cran/rjags)
